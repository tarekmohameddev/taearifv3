# دليل معالجة الأخطاء

## نظرة عامة

تم تطوير نظام شامل لمعالجة الأخطاء في التطبيق لتحسين تجربة المستخدم وتوفير معلومات مفيدة للمطورين.

## المكونات الرئيسية

### 1. `lib/axiosInstance.js`

معالج الأخطاء الرئيسي لجميع طلبات HTTP:

- **أخطاء المصادقة (401)**: إعادة توجيه تلقائي لصفحة تسجيل الدخول
- **أخطاء الخادم (500+)**: تسجيل مفصل مع إمكانية إعادة المحاولة
- **أخطاء العميل (400-499)**: رسائل خطأ واضحة
- **أخطاء الشبكة**: معالجة مشاكل الاتصال

### 2. `utils/errorHandler.js`

أدوات مساعدة لمعالجة الأخطاء:

```javascript
import {
  getErrorInfo,
  retryWithBackoff,
  logError,
  formatErrorMessage,
} from "@/utils/errorHandler";

// تحديد نوع الخطأ
const errorInfo = getErrorInfo(error);

// إعادة المحاولة مع تأخير متزايد
const result = await retryWithBackoff(
  async () => {
    return await apiCall();
  },
  3,
  1000,
);

// تسجيل الخطأ
logError(error, "functionName");

// تنسيق رسالة الخطأ للمستخدم
const userMessage = formatErrorMessage(error);
```

### 3. `components/ui/error-display.tsx`

مكونات عرض الأخطاء في واجهة المستخدم:

- `ErrorDisplay`: عرض مفصل للخطأ مع إمكانية إعادة المحاولة
- `ErrorMessage`: عرض مبسط للخطأ

## أنواع الأخطاء المدعومة

### أخطاء الخادم (500+)

- **السبب**: مشاكل في الخادم أو قاعدة البيانات
- **المعالجة**: إعادة محاولة تلقائية مع تأخير متزايد
- **الرسالة**: "خطأ في الخادم. يرجى المحاولة مرة أخرى لاحقاً"

### أخطاء الشبكة

- **السبب**: مشاكل في الاتصال بالإنترنت
- **المعالجة**: إعادة محاولة تلقائية
- **الرسالة**: "خطأ في الاتصال بالخادم. تحقق من اتصال الإنترنت"

### أخطاء المصادقة (401)

- **السبب**: انتهاء صلاحية الجلسة
- **المعالجة**: إعادة توجيه تلقائي لصفحة تسجيل الدخول
- **الرسالة**: "تم فقدان التوثيق. الرجاء إعادة تسجيل الدخول"

### أخطاء العميل (400-499)

- **السبب**: بيانات غير صحيحة أو طلب غير صالح
- **المعالجة**: عرض رسالة خطأ واضحة
- **الرسالة**: تختلف حسب نوع الخطأ

## الاستخدام في المكونات

### في Store (Zustand)

```javascript
import {
  getErrorInfo,
  logError,
  formatErrorMessage,
} from "@/utils/errorHandler";

fetchData: async () => {
  try {
    const response = await axiosInstance.get("/api/data");
    // معالجة النجاح
  } catch (error) {
    const errorInfo = logError(error, "fetchData");
    set({ error: formatErrorMessage(error) });
  }
};
```

### في المكونات

```jsx
import { ErrorDisplay } from "@/components/ui/error-display";

function MyComponent() {
  const { data, error, loading, fetchData } = useStore();

  if (error) {
    return (
      <ErrorDisplay
        error={error}
        onRetry={fetchData}
        title="خطأ في تحميل البيانات"
      />
    );
  }

  // باقي المكون
}
```

## إعدادات إعادة المحاولة

- **عدد المحاولات القصوى**: 3
- **التأخير الأساسي**: 1000ms
- **نوع التأخير**: تأخير متزايد أسي (1s, 2s, 4s)
- **شروط إعادة المحاولة**: أخطاء الخادم (500+) وأخطاء الشبكة

## تسجيل الأخطاء

يتم تسجيل جميع الأخطاء في وحدة التحكم مع:

- نوع الخطأ
- رسالة الخطأ
- رسالة المستخدم
- الوقت
- رابط الطلب (إن وجد)
- الخطأ الأصلي

## أفضل الممارسات

1. **استخدم `formatErrorMessage`** لعرض رسائل مناسبة للمستخدم
2. **استخدم `logError`** لتسجيل الأخطاء مع السياق
3. **استخدم `retryWithBackoff`** للطلبات التي قد تفشل مؤقتاً
4. **اعرض أزرار إعادة المحاولة** للمستخدم عند الحاجة
5. **تجنب عرض تفاصيل تقنية** للمستخدم النهائي

## التحديثات المستقبلية

- إضافة نظام إشعارات للأخطاء
- تكامل مع خدمات مراقبة الأخطاء الخارجية
- إضافة إحصائيات الأخطاء
- تحسين رسائل الخطأ بناءً على لغة المستخدم
