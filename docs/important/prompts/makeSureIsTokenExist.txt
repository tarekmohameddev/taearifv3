# Ensure Token Exists Before Making API Requests

## Problem
When making API requests that require authentication, the request might execute before the token is available in the AuthStore. This can cause:
- 401 Unauthorized errors
- Failed requests due to missing Authorization header
- Race conditions where requests fire before authentication completes

## Solution Pattern

### Step 1: Import useAuthStore
Always import the AuthStore to access authentication state:

```typescript
import useAuthStore from "@/context/AuthContext";
```

### Step 2: Get Token and Loading State
Extract the token and loading state from the AuthStore:

```typescript
const { userData, IsLoading: authLoading } = useAuthStore();
```

**Note:** We rename `IsLoading` to `authLoading` to avoid conflicts with local loading states.

### Step 3: Add Token Check in useEffect
Before making any API request, check if the token exists and authentication is complete:

```typescript
useEffect(() => {
  // Wait until token is fetched
  if (authLoading || !userData?.token) {
    return; // Exit early if token is not ready
  }

  const fetchData = async () => {
    try {
      setLoading(true);
      const response = await axiosInstance.get('/api/endpoint');
      // Handle response...
    } catch (err) {
      // Handle error...
    } finally {
      setLoading(false);
    }
  };

  if (/* required conditions */) {
    fetchData();
  }
}, [/* dependencies including userData?.token and authLoading */]);
```

## Complete Example

```typescript
"use client";

import { useState, useEffect } from "react";
import axiosInstance from "@/lib/axiosInstance";
import useAuthStore from "@/context/AuthContext";

export default function MyComponent() {
  const { userData, IsLoading: authLoading } = useAuthStore();
  const [loading, setLoading] = useState(true);
  const [data, setData] = useState(null);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // Wait until token is fetched
    if (authLoading || !userData?.token) {
      return;
    }

    const fetchData = async () => {
      try {
        setLoading(true);
        setError(null);
        const response = await axiosInstance.get('/v1/crm/requests/11/details');
        
        if (response.data.status === "success") {
          setData(response.data.data);
        } else {
          setError("Failed to load data");
        }
      } catch (err: any) {
        console.error("Error fetching data:", err);
        setError(
          err.response?.data?.message || "An error occurred while loading data"
        );
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [userData?.token, authLoading]); // Include token and authLoading in dependencies

  if (loading) {
    return <div>Loading...</div>;
  }

  if (error) {
    return <div>Error: {error}</div>;
  }

  return <div>{/* Render data */}</div>;
}
```

## Key Points

1. **Always check `authLoading`**: This ensures we wait for the authentication process to complete
2. **Check `userData?.token`**: Verify the token actually exists before making requests
3. **Include in dependencies**: Add `userData?.token` and `authLoading` to the useEffect dependency array
4. **Early return**: Use early return pattern to exit the effect if token is not ready
5. **Rename IsLoading**: Rename `IsLoading` to `authLoading` to avoid naming conflicts

## When to Apply This Pattern

Apply this pattern when:
- Making authenticated API requests
- Component mounts and needs to fetch data immediately
- Token might not be available on initial render
- Authentication state is managed by AuthStore

## When NOT to Apply

You don't need this pattern for:
- Public endpoints that don't require authentication
- Components that only render after authentication is confirmed
- Server-side requests (where token is handled differently)

## Related Files

- `lib/axiosInstance.js` - Axios instance with automatic token injection
- `context/AuthContext.js` - Authentication store with token management
- `docs/important/dashboard/CORE_INFRASTRUCTURE.md` - Core infrastructure documentation

