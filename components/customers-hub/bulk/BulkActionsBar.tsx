"use client";

import React, { useState } from "react";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import {
  X,
  Edit,
  Mail,
  MessageSquare,
  Tag,
  UserPlus,
  TrendingUp,
  Archive,
  Trash2,
  Download,
} from "lucide-react";
import useUnifiedCustomersStore from "@/context/store/unified-customers";
import useAssignmentRulesStore from "@/context/store/assignment-rules";
import { LIFECYCLE_STAGES } from "@/types/unified-customer";
import type { CustomerLifecycleStage, Priority } from "@/types/unified-customer";
import { toast } from "sonner";

interface BulkActionsBarProps {
  selectedIds: string[];
  onClearSelection: () => void;
}

export function BulkActionsBar({ selectedIds, onClearSelection }: BulkActionsBarProps) {
  const { customers, updateCustomer } = useUnifiedCustomersStore();
  const { employees, assignCustomerManually } = useAssignmentRulesStore();
  const [showStageDialog, setShowStageDialog] = useState(false);
  const [showPriorityDialog, setShowPriorityDialog] = useState(false);
  const [showTagDialog, setShowTagDialog] = useState(false);
  const [showEmailDialog, setShowEmailDialog] = useState(false);
  const [showAssignDialog, setShowAssignDialog] = useState(false);
  const [selectedStage, setSelectedStage] = useState<CustomerLifecycleStage | "">("");
  const [selectedPriority, setSelectedPriority] = useState<Priority | "">("");
  const [newTags, setNewTags] = useState("");
  const [emailSubject, setEmailSubject] = useState("");
  const [emailBody, setEmailBody] = useState("");
  const [assignToEmployee, setAssignToEmployee] = useState("");

  const selectedCustomers = customers.filter((c) => selectedIds.includes(c.id));

  // Bulk update stage
  const handleBulkStageUpdate = () => {
    if (!selectedStage) return;

    selectedIds.forEach((id) => {
      const customer = customers.find((c) => c.id === id);
      if (customer) {
        updateCustomer(id, {
          stage: selectedStage,
          stageHistory: [
            ...customer.stageHistory,
            {
              id: `stage_${Date.now()}_${Math.random()}`,
              fromStage: customer.stage,
              toStage: selectedStage,
              changedBy: "Current User",
              changedById: "current_user_id",
              changedAt: new Date().toISOString(),
              reason: "Bulk update",
              autoGenerated: false,
            },
          ],
        });
      }
    });

    toast.success(`ุชู ุชุญุฏูุซ ${selectedIds.length} ุนููู ุฅูู ูุฑุญูุฉ ุฌุฏูุฏุฉ`);
    setShowStageDialog(false);
    setSelectedStage("");
    onClearSelection();
  };

  // Bulk update priority
  const handleBulkPriorityUpdate = () => {
    if (!selectedPriority) return;

    selectedIds.forEach((id) => {
      updateCustomer(id, { priority: selectedPriority });
    });

    toast.success(`ุชู ุชุญุฏูุซ ุฃููููุฉ ${selectedIds.length} ุนููู`);
    setShowPriorityDialog(false);
    setSelectedPriority("");
    onClearSelection();
  };

  // Bulk add tags
  const handleBulkAddTags = () => {
    if (!newTags.trim()) return;

    const tagsArray = newTags.split(",").map((t) => t.trim()).filter(Boolean);

    selectedIds.forEach((id) => {
      const customer = customers.find((c) => c.id === id);
      if (customer) {
        const updatedTags = Array.from(new Set([...customer.tags, ...tagsArray]));
        updateCustomer(id, { tags: updatedTags });
      }
    });

    toast.success(`ุชู ุฅุถุงูุฉ ${tagsArray.length} ูุณู ูู ${selectedIds.length} ุนููู`);
    setShowTagDialog(false);
    setNewTags("");
    onClearSelection();
  };

  // Bulk send email
  const handleBulkEmail = () => {
    // TODO: Integrate with email service
    console.log("Sending bulk email:", {
      recipients: selectedCustomers.map((c) => c.email).filter(Boolean),
      subject: emailSubject,
      body: emailBody,
    });

    toast.success(`ุชู ุฅุฑุณุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูู ${selectedIds.length} ุนููู`);
    setShowEmailDialog(false);
    setEmailSubject("");
    setEmailBody("");
    onClearSelection();
  };

  // Bulk assign
  const handleBulkAssign = async () => {
    if (!assignToEmployee) return;

    try {
      await assignCustomerManually({
        customerIds: selectedIds,
        employeeId: assignToEmployee,
        reason: "Bulk assignment",
      });

      toast.success(`ุชู ุชุนููู ${selectedIds.length} ุนููู`);
      setShowAssignDialog(false);
      setAssignToEmployee("");
      onClearSelection();
    } catch (error) {
      toast.error("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุนููู");
    }
  };

  // Export selected
  const handleExport = (format: "csv" | "excel" | "pdf") => {
    // TODO: Implement actual export
    console.log(`Exporting ${selectedIds.length} customers to ${format}`);
    toast.success(`ุฌุงุฑู ุชุตุฏูุฑ ${selectedIds.length} ุนููู ูู ${format.toUpperCase()}`);
  };

  if (selectedIds.length === 0) return null;

  return (
    <>
      <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 animate-in slide-in-from-bottom-5">
        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-full shadow-2xl px-6 py-4 flex items-center gap-4">
          {/* Selection Count */}
          <div className="flex items-center gap-2">
            <Badge variant="secondary" className="bg-white/20 text-white">
              {selectedIds.length}
            </Badge>
            <span className="font-medium">ุชู ุงูุชุญุฏูุฏ</span>
          </div>

          <div className="h-6 w-px bg-white/30" />

          {/* Actions */}
          <div className="flex items-center gap-2">
            {/* Change Stage */}
            <Button
              variant="ghost"
              size="sm"
              className="text-white hover:bg-white/20"
              onClick={() => setShowStageDialog(true)}
            >
              <TrendingUp className="h-4 w-4 ml-2" />
              ุชุบููุฑ ุงููุฑุญูุฉ
            </Button>

            {/* Change Priority */}
            <Button
              variant="ghost"
              size="sm"
              className="text-white hover:bg-white/20"
              onClick={() => setShowPriorityDialog(true)}
            >
              <Edit className="h-4 w-4 ml-2" />
              ุงูุฃููููุฉ
            </Button>

            {/* Add Tags */}
            <Button
              variant="ghost"
              size="sm"
              className="text-white hover:bg-white/20"
              onClick={() => setShowTagDialog(true)}
            >
              <Tag className="h-4 w-4 ml-2" />
              ุฅุถุงูุฉ ูุณู
            </Button>

            {/* Assign */}
            <Button
              variant="ghost"
              size="sm"
              className="text-white hover:bg-white/20"
              onClick={() => setShowAssignDialog(true)}
            >
              <UserPlus className="h-4 w-4 ml-2" />
              ุชุนููู
            </Button>

            {/* More Actions */}
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button
                  variant="ghost"
                  size="sm"
                  className="text-white hover:bg-white/20"
                >
                  ุงููุฒูุฏ
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end" className="w-48">
                <DropdownMenuLabel>ุฅุฌุฑุงุกุงุช ุฅุถุงููุฉ</DropdownMenuLabel>
                <DropdownMenuSeparator />
                
                <DropdownMenuItem onClick={() => setShowEmailDialog(true)}>
                  <Mail className="h-4 w-4 ml-2" />
                  ุฅุฑุณุงู ุจุฑูุฏ
                </DropdownMenuItem>

                <DropdownMenuItem>
                  <MessageSquare className="h-4 w-4 ml-2" />
                  ุฅุฑุณุงู ูุงุชุณุงุจ
                </DropdownMenuItem>

                <DropdownMenuSeparator />

                <DropdownMenuItem onClick={() => handleExport("csv")}>
                  <Download className="h-4 w-4 ml-2" />
                  ุชุตุฏูุฑ CSV
                </DropdownMenuItem>

                <DropdownMenuItem onClick={() => handleExport("excel")}>
                  <Download className="h-4 w-4 ml-2" />
                  ุชุตุฏูุฑ Excel
                </DropdownMenuItem>

                <DropdownMenuItem onClick={() => handleExport("pdf")}>
                  <Download className="h-4 w-4 ml-2" />
                  ุชุตุฏูุฑ PDF
                </DropdownMenuItem>

                <DropdownMenuSeparator />

                <DropdownMenuItem className="text-red-600">
                  <Archive className="h-4 w-4 ml-2" />
                  ุฃุฑุดูุฉ
                </DropdownMenuItem>

                <DropdownMenuItem className="text-red-600">
                  <Trash2 className="h-4 w-4 ml-2" />
                  ุญุฐู
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          </div>

          <div className="h-6 w-px bg-white/30" />

          {/* Clear Selection */}
          <Button
            variant="ghost"
            size="sm"
            className="text-white hover:bg-white/20"
            onClick={onClearSelection}
          >
            <X className="h-4 w-4" />
          </Button>
        </div>
      </div>

      {/* Change Stage Dialog */}
      <Dialog open={showStageDialog} onOpenChange={setShowStageDialog}>
        <DialogContent dir="rtl">
          <DialogHeader>
            <DialogTitle>ุชุบููุฑ ุงููุฑุญูุฉ - {selectedIds.length} ุนููู</DialogTitle>
            <DialogDescription>
              ุงุฎุชุฑ ุงููุฑุญูุฉ ุงูุฌุฏูุฏุฉ ููุนููุงุก ุงููุญุฏุฏูู
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>ุงููุฑุญูุฉ ุงูุฌุฏูุฏุฉ</Label>
              <Select
                value={selectedStage}
                onValueChange={(value) => setSelectedStage(value as CustomerLifecycleStage)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="ุงุฎุชุฑ ุงููุฑุญูุฉ" />
                </SelectTrigger>
                <SelectContent>
                  {LIFECYCLE_STAGES.map((stage) => (
                    <SelectItem key={stage.id} value={stage.id}>
                      <div className="flex items-center gap-2">
                        <div
                          className="w-3 h-3 rounded-full"
                          style={{ backgroundColor: stage.color }}
                        />
                        {stage.nameAr}
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowStageDialog(false)}>
              ุฅูุบุงุก
            </Button>
            <Button onClick={handleBulkStageUpdate} disabled={!selectedStage}>
              ุชุญุฏูุซ ุงููุฑุญูุฉ
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Change Priority Dialog */}
      <Dialog open={showPriorityDialog} onOpenChange={setShowPriorityDialog}>
        <DialogContent dir="rtl">
          <DialogHeader>
            <DialogTitle>ุชุบููุฑ ุงูุฃููููุฉ - {selectedIds.length} ุนููู</DialogTitle>
            <DialogDescription>
              ุงุฎุชุฑ ุงูุฃููููุฉ ุงูุฌุฏูุฏุฉ ููุนููุงุก ุงููุญุฏุฏูู
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>ุงูุฃููููุฉ ุงูุฌุฏูุฏุฉ</Label>
              <Select
                value={selectedPriority}
                onValueChange={(value) => setSelectedPriority(value as Priority)}
              >
                <SelectTrigger>
                  <SelectValue placeholder="ุงุฎุชุฑ ุงูุฃููููุฉ" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="urgent">๐จ ุนุงุฌู</SelectItem>
                  <SelectItem value="high">๐ฅ ุนุงูู</SelectItem>
                  <SelectItem value="medium">โญ ูุชูุณุท</SelectItem>
                  <SelectItem value="low">๐ ููุฎูุถ</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowPriorityDialog(false)}>
              ุฅูุบุงุก
            </Button>
            <Button onClick={handleBulkPriorityUpdate} disabled={!selectedPriority}>
              ุชุญุฏูุซ ุงูุฃููููุฉ
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Add Tags Dialog */}
      <Dialog open={showTagDialog} onOpenChange={setShowTagDialog}>
        <DialogContent dir="rtl">
          <DialogHeader>
            <DialogTitle>ุฅุถุงูุฉ ูุณูู - {selectedIds.length} ุนููู</DialogTitle>
            <DialogDescription>
              ุฃุฏุฎู ุงููุณูู ููุตููุฉ ุจููุงุตู
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>ุงููุณูู</Label>
              <Textarea
                placeholder="ูุซุงู: ุนููู ูููุ ูุชุงุจุนุฉ ุณุฑูุนุฉุ ูุณุชุซูุฑ"
                value={newTags}
                onChange={(e) => setNewTags(e.target.value)}
                rows={3}
              />
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowTagDialog(false)}>
              ุฅูุบุงุก
            </Button>
            <Button onClick={handleBulkAddTags} disabled={!newTags.trim()}>
              ุฅุถุงูุฉ ุงููุณูู
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Send Email Dialog */}
      <Dialog open={showEmailDialog} onOpenChange={setShowEmailDialog}>
        <DialogContent dir="rtl" className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>ุฅุฑุณุงู ุจุฑูุฏ ุฅููุชุฑููู - {selectedIds.length} ุนููู</DialogTitle>
            <DialogDescription>
              ุณูุชู ุฅุฑุณุงู ุงูุจุฑูุฏ ููู ุงูุนููุงุก ุงููุญุฏุฏูู
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>ุงูููุถูุน</Label>
              <input
                type="text"
                className="w-full px-3 py-2 border rounded-md"
                placeholder="ููุถูุน ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"
                value={emailSubject}
                onChange={(e) => setEmailSubject(e.target.value)}
              />
            </div>

            <div className="space-y-2">
              <Label>ุงูุฑุณุงูุฉ</Label>
              <Textarea
                placeholder="ูุต ุงูุฑุณุงูุฉ..."
                value={emailBody}
                onChange={(e) => setEmailBody(e.target.value)}
                rows={8}
              />
            </div>

            <div className="text-sm text-gray-500">
              ููููู ุงุณุชุฎุฏุงู ุงููุชุบูุฑุงุช: {"{customerName}"}, {"{propertyName}"}, {"{agentName}"}
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowEmailDialog(false)}>
              ุฅูุบุงุก
            </Button>
            <Button onClick={handleBulkEmail} disabled={!emailSubject || !emailBody}>
              <Mail className="h-4 w-4 ml-2" />
              ุฅุฑุณุงู ุงูุจุฑูุฏ
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Assign Dialog */}
      <Dialog open={showAssignDialog} onOpenChange={setShowAssignDialog}>
        <DialogContent dir="rtl">
          <DialogHeader>
            <DialogTitle>ุชุนููู ููุธู - {selectedIds.length} ุนููู</DialogTitle>
            <DialogDescription>
              ุงุฎุชุฑ ุงูููุธู ุงููุณุคูู ุนู ุงูุนููุงุก ุงููุญุฏุฏูู
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="space-y-2">
              <Label>ุงูููุธู</Label>
              <Select value={assignToEmployee} onValueChange={setAssignToEmployee}>
                <SelectTrigger>
                  <SelectValue placeholder="ุงุฎุชุฑ ุงูููุธู" />
                </SelectTrigger>
                <SelectContent>
                  {employees.filter((e) => e.isActive).map((employee) => (
                    <SelectItem key={employee.id} value={employee.id}>
                      <div className="flex items-center gap-2">
                        <span>{employee.name}</span>
                        <span className="text-xs text-gray-500">
                          ({employee.loadPercentage}% ุชุญููู)
                        </span>
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowAssignDialog(false)}>
              ุฅูุบุงุก
            </Button>
            <Button onClick={handleBulkAssign} disabled={!assignToEmployee}>
              ุชุนููู ุงูููุธู
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </>
  );
}
